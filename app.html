<!DOCTYPE html>
<html lang="en">
<head>
  <!-- (Optional) AdSense loader - keep if you already use it -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9902358545401183"
    crossorigin="anonymous"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CryptoVision ‚Äì AI Crypto Insights</title>
  <meta name="description" content="CryptoVision ‚Äì live crypto prices + AI insights. Backend proxy + fallback." />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#050816;
      --bg2:#081026;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,.15);
      --danger:#f97373;
      --danger-soft:rgba(248,113,113,.15);
      --warning:#eab308;
      --text:#e5e7eb;
      --text-soft:#9ca3af;
      --border:#1f2937;
      --card:#0f172a;
      --card-soft:rgba(15,23,42,.9);
      --shadow:0 22px 60px rgba(0,0,0,.55);
      --font:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:var(--font);
      background:radial-gradient(circle at top,#111827,#020617);
      color:var(--text);
      display:flex;
      justify-content:center;
      padding:24px 12px;
    }
    .shell{
      width:100%;
      max-width:1280px;
      background:linear-gradient(135deg,#020617,#020617 40%,#020617 60%,#020617);
      border-radius:32px;
      box-shadow:var(--shadow);
      padding:24px 24px 28px;
      border:1px solid rgba(148,163,184,.25);
      position:relative;
      overflow:hidden;
    }
    .shell::before{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,.11), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(79,70,229,.11), transparent 55%),
        radial-gradient(circle at 50% 100%, rgba(34,197,94,.12), transparent 55%);
      opacity:.9; pointer-events:none; z-index:-1;
    }

    .top-bar{
      display:flex; justify-content:space-between; gap:16px;
      align-items:center; margin-bottom:18px; flex-wrap:wrap;
    }
    .logo-wrap{display:flex; align-items:center; gap:14px}
    .logo-badge{
      width:40px;height:40px;border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#4ade80,#22c55e);
      display:flex;align-items:center;justify-content:center;
      color:#020617;font-weight:800;font-size:18px;
      box-shadow:0 0 0 1px rgba(15,23,42,.5),0 18px 38px rgba(22,163,74,.55);
    }
    .title-block h1{
      font-size:22px; letter-spacing:.03em;
      display:flex; align-items:center; gap:8px;
    }
    .title-pill{
      font-size:11px; padding:2px 8px; border-radius:999px;
      border:1px solid rgba(96,165,250,.7);
      color:#bfdbfe;
      background:linear-gradient(135deg,rgba(37,99,235,.45),rgba(56,189,248,.1));
      text-transform:uppercase;
    }
    .title-block p{font-size:13px;color:var(--text-soft);margin-top:3px}

    .status-wrap{display:flex; flex-direction:column; align-items:flex-end; gap:6px; font-size:12px}
    .live-badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      background:rgba(22,163,74,.12); color:#bbf7d0;
      border:1px solid rgba(34,197,94,.6);
      font-size:11px; text-transform:uppercase; letter-spacing:.08em;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.3)}
    .updated-at{font-size:12px;color:var(--text-soft)}
    .source-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(15,23,42,.6);
      color:#cbd5e1; font-size:11px;
      max-width:100%;
    }
    .source-dot{
      width:8px;height:8px;border-radius:999px; background:#60a5fa;
      box-shadow:0 0 0 4px rgba(96,165,250,.18);
      flex:0 0 auto;
    }
    .source-dot.ok{background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.18);}
    .source-dot.warn{background:#eab308; box-shadow:0 0 0 4px rgba(234,179,8,.18);}
    .source-dot.bad{background:#f97373; box-shadow:0 0 0 4px rgba(249,115,115,.18);}
    .source-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    .grid-top{
      display:grid; grid-template-columns:minmax(0,3fr) minmax(0,2fr);
      gap:18px; margin-bottom:16px;
    }
    .pill-row{display:flex; flex-wrap:wrap; gap:10px}
    .feature-pill{
      display:flex; align-items:center; gap:6px;
      padding:7px 10px; border-radius:999px; font-size:11px;
      background:rgba(15,23,42,.8);
      border:1px solid rgba(148,163,184,.35);
      backdrop-filter:blur(16px);
    }
    .feature-pill span.icon{
      width:16px;height:16px;border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:11px;
    }
    .feature-pill.good span.icon{background:rgba(34,197,94,.18);color:#bbf7d0}
    .feature-pill.info span.icon{background:rgba(59,130,246,.18);color:#bfdbfe}
    .feature-pill.ad span.icon{background:rgba(234,179,8,.18);color:#fef9c3}
    .mini-note{font-size:11px;color:#9ca3af;margin-top:6px}

    .top-info-card{
      padding:10px 14px; border-radius:18px;
      background:rgba(15,23,42,.88);
      border:1px solid rgba(148,163,184,.35);
      backdrop-filter:blur(16px); font-size:12px;
    }
    .top-info-card strong{color:#e5e7eb}

    .main-grid{
      display:grid;
      grid-template-columns:minmax(0,3.3fr) minmax(0,2.7fr);
      gap:18px;
    }
    .card{
      background:var(--card-soft);
      border-radius:22px;
      padding:14px 14px 16px;
      border:1px solid rgba(148,163,184,.3);
      box-shadow:0 18px 45px rgba(15,23,42,.9);
      backdrop-filter:blur(18px);
      position:relative; overflow:hidden;
    }

    .card-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px}
    .card-title{font-size:14px;font-weight:600}
    .card-subtitle{font-size:11px;color:var(--text-soft)}
    .badge{
      padding:3px 8px; border-radius:999px;
      font-size:10px; letter-spacing:.06em; text-transform:uppercase;
      border:1px solid rgba(148,163,184,.5); color:#e5e7eb;
    }
    .badge.green{border-color:rgba(34,197,94,.7);background:rgba(22,163,74,.12);color:#bbf7d0}
    .badge.blue{border-color:rgba(59,130,246,.7);background:rgba(37,99,235,.18);color:#bfdbfe}
    .badge.orange{border-color:rgba(234,179,8,.7);background:rgba(234,179,8,.16);color:#fef3c7}
    .badge.gray{border-color:rgba(148,163,184,.35);background:rgba(15,23,42,.5);color:#e5e7eb}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;align-items:center;font-size:12px}
    .search-box{flex:1}
    .search-input{
      width:100%; padding:7px 9px; border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(15,23,42,.9); color:var(--text);
      font-size:12px; outline:none;
    }
    .search-input::placeholder{color:#6b7280}
    .select-small,.btn-small{
      border-radius:999px; border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.9); color:var(--text-soft);
      font-size:11px; padding:6px 9px; outline:none; cursor:pointer;
    }
    .btn-small.primary{
      background:linear-gradient(to right,#2563eb,#22c55e);
      border-color:transparent; color:#ecfeff; font-weight:500;
    }
    .btn-small[disabled]{opacity:.55; cursor:not-allowed; filter:none;}

    .table-wrap{
      max-height:420px; overflow:auto; border-radius:16px;
      border:1px solid rgba(31,41,55,.9);
      background:radial-gradient(circle at top, rgba(15,23,42,.96), #020617);
    }
    table{width:100%; border-collapse:collapse; font-size:12px}
    thead{
      background:rgba(15,23,42,.95);
      position:sticky; top:0; z-index:2;
    }
    th,td{
      padding:7px 10px; text-align:right;
      border-bottom:1px solid rgba(31,41,55,.9);
      white-space:nowrap;
    }
    th:first-child,td:first-child{text-align:left}
    th:nth-child(2),td:nth-child(2){text-align:left}
    th{
      font-size:11px; color:#9ca3af;
      text-transform:uppercase; letter-spacing:.06em;
    }
    tbody tr{cursor:pointer; transition:background .15s ease-out}
    tbody tr:nth-child(even){background:rgba(15,23,42,.85)}
    tbody tr:hover{background:rgba(37,99,235,.18)}
    .rank{color:#6b7280;font-size:11px}
    .coin-name{display:flex; align-items:center; gap:6px}
    .coin-symbol{
      font-size:10px; text-transform:uppercase; color:#9ca3af;
      padding:1px 5px; border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
    }
    .chg-pos{color:#22c55e}
    .chg-neg{color:#f97373}

    .ai-text{font-size:12px; line-height:1.55; color:#e5e7eb}
    .ai-text strong{color:#bfdbfe}
    .ai-list{margin-top:8px; list-style:none; font-size:12px; color:#cbd5f5}
    .ai-list li{margin-bottom:4px; position:relative; padding-left:14px}
    .ai-list li::before{content:"‚Ä¢"; position:absolute; left:2px; color:#60a5fa}

    .small-label{font-size:11px; color:#9ca3af; margin-bottom:4px}
    .pair-header{display:flex; justify-content:space-between; align-items:baseline; margin-bottom:4px; gap:4px; flex-wrap:wrap}
    .pair-name{font-size:14px; font-weight:600}
    .pair-symbol{font-size:11px; text-transform:uppercase; color:#9ca3af}
    .big-price{font-size:20px; font-weight:600}

    .pill-row-small{display:flex; flex-wrap:wrap; gap:6px; margin:6px 0 10px; font-size:11px}
    .pill-info{
      padding:3px 7px; border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      color:#e5e7eb; background:rgba(15,23,42,.9);
    }
    .pill-info.green{border-color:rgba(34,197,94,.7); background:var(--accent-soft); color:#bbf7d0}
    .pill-info.red{border-color:rgba(248,113,113,.75); background:var(--danger-soft); color:#fecaca}

    .metric-grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; font-size:11px; margin-bottom:10px}
    .metric-item{
      padding:6px 8px; border-radius:12px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(30,64,175,.8);
    }
    .metric-label{color:#9ca3af; margin-bottom:2px}
    .metric-value{font-weight:600}
    .metric-note{font-size:10px; color:#9ca3af; margin-top:2px}

    .ai-comment{
      margin-top:2px;
      padding:7px 9px;
      border-radius:12px;
      background:rgba(15,23,42,.9);
      border:1px dashed rgba(148,163,184,.7);
      font-size:12px; line-height:1.5;
      color:#e5e7eb;
    }

    .scenario-block{margin-top:8px; font-size:11px}
    .scenario-block strong{color:#bfdbfe}
    .scenario-list{list-style:none; margin-top:6px}
    .scenario-list li{margin-bottom:6px; line-height:1.4}

    .chart-wrap{
      margin-top:10px;
      background:radial-gradient(circle at top, rgba(30,64,175,.4), #020617);
      border-radius:14px;
      padding:8px 8px 4px;
      border:1px solid rgba(30,64,175,.8);
    }
    .chart-wrap canvas{width:100%; height:210px; max-height:210px}

    .ad-card{
      margin-top:12px;
      padding:10px 12px;
      border-radius:16px;
      border:1px dashed rgba(234,179,8,.7);
      background:rgba(24,16,3,.8);
      font-size:11px; color:#fef9c3;
    }
    .ad-card strong{color:#facc15}

    .footer-note{margin-top:10px; font-size:10px; color:#6b7280; text-align:right}

    .backend-grid{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,1fr);
      gap:12px;
      margin-top:16px;
    }
    .panel{
      border-radius:18px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(15,23,42,.75);
      padding:14px;
    }
    .panel h2,.panel h3{font-size:14px; margin-bottom:8px}
    .panel p{font-size:12px; color:var(--text-soft); line-height:1.5}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:10px 0}
    .input{
      padding:7px 10px; border-radius:10px;
      border:1px solid rgba(148,163,184,.35);
      background:#020617; color:#f9fafb;
      min-width:180px; outline:none;
    }
    .btn{
      padding:7px 14px; border-radius:999px;
      border:none; background:#22c55e; color:#020617;
      font-weight:800; cursor:pointer;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn[disabled]{opacity:.55; cursor:not-allowed; filter:none;}
    pre{
      max-height:260px; overflow:auto;
      background:#020617; border-radius:12px;
      padding:10px; font-size:12px;
      border:1px solid #1f2937; color:#e5e7eb;
      white-space:pre-wrap;
    }

    @media (max-width: 900px){
      body{padding:12px 6px}
      .shell{border-radius:20px; padding:14px}
      .grid-top,.main-grid,.backend-grid{grid-template-columns:minmax(0,1fr)}
      .status-wrap{align-items:flex-start}
      .table-wrap{max-height:360px}
    }
  </style>
</head>

<body>
  <div class="shell">

    <header class="top-bar">
      <div class="logo-wrap">
        <div class="logo-badge">CV</div>
        <div class="title-block">
          <h1>CryptoVision <span class="title-pill">AI Crypto Insights</span></h1>
          <p>Live crypto prices + AI insights. (Backend proxy + fallback)</p>
        </div>
      </div>
      <div class="status-wrap">
        <div class="live-badge"><span class="dot"></span><span>Live market feed (real-time-ish)</span></div>
        <div class="updated-at" id="updatedAtText">Updated: ‚Äî</div>
        <div class="source-badge" title="Data source status">
          <span id="sourceDot" class="source-dot warn"></span>
          <span id="sourceText" class="source-text">Source: checking‚Ä¶</span>
        </div>
      </div>
    </header>

    <section class="grid-top">
      <div>
        <div class="pill-row">
          <div class="feature-pill good"><span class="icon">‚úì</span><span class="label">Top 50 markets (backend proxy)</span></div>
          <div class="feature-pill good"><span class="icon">‚úì</span><span class="label">CoinGecko fallback (auto)</span></div>
          <div class="feature-pill info"><span class="icon">AI</span><span class="label">Per-coin AI scenarios</span></div>
          <div class="feature-pill info"><span class="icon">UX</span><span class="label">Modern blue + dark UI</span></div>
          <div class="feature-pill ad"><span class="icon">Ad</span><span class="label">AdSense / affiliate area</span></div>
          <div class="feature-pill info"><span class="icon">‚àû</span><span class="label">Ready for subscription</span></div>
        </div>
        <p class="mini-note">
          Markets load via Render backend proxy. If backend is down/sleeping, it falls back to CoinGecko direct.
        </p>
      </div>

      <div class="top-info-card">
        <div class="card-header" style="margin-bottom:6px;">
          <div>
            <div class="card-title">CryptoVision AI module</div>
            <div class="card-subtitle">Per-coin prediction + probability scenarios.</div>
          </div>
          <span class="badge blue">Live</span>
        </div>
        <p style="margin-bottom:4px;">
          <strong>How it works:</strong> select a coin and the app calls your backend <code>/ai/predict</code>,
          then formats the output into ‚ÄúMost probable / Alternative / Rare‚Äù scenarios.
        </p>
        <p class="mini-note">
          Educational / informational only. Not financial advice.
        </p>
      </div>
    </section>

    <section class="main-grid">
      <article class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Watched coins</div>
            <div class="card-subtitle">Top 50 by market cap ‚Äì backend proxy + fallback.</div>
          </div>
          <span class="badge gray">USD</span>
        </div>

        <div class="toolbar">
          <div class="search-box">
            <input id="searchInput" class="search-input" type="text" placeholder="Search coin (e.g. bitcoin, eth, bnb)..." />
          </div>
          <select id="sortSelect" class="select-small">
            <option value="rank">Sort: Market Cap</option>
            <option value="change24">Sort: Biggest 24h moves</option>
            <option value="change1h">Sort: Biggest 1h moves</option>
            <option value="change7d">Sort: Biggest 7d moves</option>
          </select>
          <button id="refreshBtn" class="btn-small primary" title="Manual refresh is rate-limited to 60s">Refresh</button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Coin</th>
                <th>Price</th>
                <th>1h</th>
                <th>24h</th>
                <th>7d</th>
                <th>Market Cap</th>
              </tr>
            </thead>
            <tbody id="coinsBody"></tbody>
          </table>
        </div>
      </article>

      <article>
        <div class="card" style="margin-bottom:12px;">
          <div class="card-header">
            <div>
              <div class="card-title">CryptoVision ‚Äì Daily Insight</div>
              <div class="card-subtitle">Quick summary based on the top 50 coins.</div>
            </div>
            <span class="badge green">Rules</span>
          </div>
          <div class="ai-text" id="dailyInsight">Loading market analysis...</div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Selected coin analysis</div>
              <div class="card-subtitle">Click a coin in the list to get AI scenarios + chart.</div>
            </div>
            <span class="badge orange">Focus asset</span>
          </div>

          <div class="small-label">Selected</div>
          <div class="pair-header">
            <div>
              <div class="pair-name" id="selectedName">No coin selected</div>
              <div class="pair-symbol" id="selectedSymbol">Choose from the list</div>
            </div>
            <div class="big-price" id="selectedPrice">‚Äî</div>
          </div>

          <div class="pill-row-small" id="selectedPills">
            <span class="pill-info">Waiting for a selection...</span>
          </div>

          <div class="metric-grid">
            <div class="metric-item">
              <div class="metric-label">Market Cap</div>
              <div class="metric-value" id="metricMarketCap">‚Äî</div>
              <div class="metric-note">Project size vs market.</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">AI / RSI</div>
              <div class="metric-value" id="metricBias">‚Äî</div>
              <div class="metric-note">From backend prediction.</div>
            </div>
          </div>

          <div class="ai-comment" id="coinComment">
            Select a coin to load AI prediction and probability scenarios.
          </div>

          <div class="scenario-block">
            <strong>Auto scenarios:</strong>
            <ul class="scenario-list" id="scenarioList"><li>‚Äî</li></ul>
          </div>

          <div class="chart-wrap">
            <div class="small-label" style="margin-bottom:4px;">Chart ‚Äì last 7 days (USD)</div>
            <canvas id="priceChart"></canvas>
          </div>

          <div class="ad-card">
            <strong>ADS / AFFILIATE AREA</strong><br/>
            Place your AdSense units or affiliate banners here after approval.
          </div>

          <div class="footer-note">
            Educational / informational only. Not financial advice.
          </div>
        </div>
      </article>
    </section>

    <section class="backend-grid">
      <div class="panel">
        <h2>Backend Test</h2>
        <p>
          Health: <code>/health</code> ‚Ä¢ AI: <code>/ai/predict</code> (example: bitcoin, ethereum).
        </p>

        <div class="row">
          <label for="ai-coin-id-input" style="font-size:12px; color:var(--text-soft);">Coin ID:</label>
          <input id="ai-coin-id-input" class="input" type="text" value="bitcoin" />
          <button class="btn" type="button" id="btnTestBackend">Test AI</button>
          <button class="btn" type="button" id="btnHealth" style="background:#60a5fa;">Health</button>
        </div>

        <pre id="ai-backend-result">No request yet.</pre>
      </div>

      <div class="panel">
        <h3>AI Summary</h3>
        <p>This box updates after you call the AI endpoint.</p>
        <div style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:10px; font-size:12px;">
          <div>
            <div style="opacity:.75;">Coin</div>
            <strong id="ai-summary-coin">-</strong>
          </div>
          <div>
            <div style="opacity:.75;">Last price</div>
            <strong id="ai-summary-last">-</strong>
          </div>
          <div>
            <div style="opacity:.75;">Predicted</div>
            <strong id="ai-summary-predicted">-</strong>
          </div>
          <div>
            <div style="opacity:.75;">RSI</div>
            <strong id="ai-summary-rsi">-</strong>
          </div>
        </div>
      </div>
    </section>

  </div>

  <script>
    // ==========================================================
    // CONFIG
    // ==========================================================
    const API_BASE = "https://api.coingecko.com/api/v3";
    const BACKEND_BASE_URL = "https://cryptovision-ldo7.onrender.com"; // no trailing slash
    const BACKEND_MARKETS_ENDPOINT = "/coins/markets";

    // Front-end rate-limit + cache
    const REFRESH_MIN_INTERVAL_MS = 60_000;
    const MARKETS_CACHE_TTL_MS = 60_000;
    const STORAGE_KEY_MARKETS = "cv_markets_cache_v1";

    // AI endpoint (REAL)
    const AI_ENDPOINT = "/ai/predict";

    // ==========================================================
    // DOM
    // ==========================================================
    const coinsBody = document.getElementById("coinsBody");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");
    const refreshBtn = document.getElementById("refreshBtn");
    const updatedAtText = document.getElementById("updatedAtText");
    const dailyInsightEl = document.getElementById("dailyInsight");

    const sourceDot = document.getElementById("sourceDot");
    const sourceText = document.getElementById("sourceText");

    const selectedNameEl = document.getElementById("selectedName");
    const selectedSymbolEl = document.getElementById("selectedSymbol");
    const selectedPriceEl = document.getElementById("selectedPrice");
    const selectedPillsEl = document.getElementById("selectedPills");
    const metricMarketCapEl = document.getElementById("metricMarketCap");
    const metricBiasEl = document.getElementById("metricBias");
    const coinCommentEl = document.getElementById("coinComment");
    const scenarioListEl = document.getElementById("scenarioList");

    const aiInput = document.getElementById("ai-coin-id-input");
    const aiResult = document.getElementById("ai-backend-result");
    const btnTestBackend = document.getElementById("btnTestBackend");
    const btnHealth = document.getElementById("btnHealth");

    // ==========================================================
    // STATE
    // ==========================================================
    let coinsRaw = [];
    let filteredCoins = [];
    let currentSort = "rank";
    let priceChart = null;
    const chartCache = new Map();

    const DataSource = {
      BACKEND: "backend-proxy",
      COINGECKO: "coingecko-direct",
      CACHE: "cache"
    };

    let isLoadingMarkets = false;
    let lastManualRefreshTs = 0;

    // ==========================================================
    // UTIL
    // ==========================================================
    function updateTimestamp() {
      const now = new Date();
      const formatted = now.toLocaleString("en-GB", {
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
      updatedAtText.textContent = "Updated: " + formatted;
    }

    function formatPrice(value) {
      if (value == null || Number.isNaN(value)) return "‚Äî";
      const v = Number(value);
      if (v >= 1000) return "$" + v.toLocaleString("en-US", { maximumFractionDigits: 0 });
      if (v >= 1) return "$" + v.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      if (v >= 0.01) return "$" + v.toLocaleString("en-US", { minimumFractionDigits: 4, maximumFractionDigits: 4 });
      return "$" + v.toLocaleString("en-US", { minimumFractionDigits: 6, maximumFractionDigits: 8 });
    }

    function formatPercent(value) {
      if (value == null || Number.isNaN(value)) return "‚Äî";
      const v = Number(value);
      const sign = v > 0 ? "+" : "";
      return sign + v.toFixed(2) + "%";
    }

    function formatNumberAbbr(value) {
      if (value == null || Number.isNaN(value)) return "‚Äî";
      const v = Number(value);
      if (v >= 1e12) return (v / 1e12).toFixed(2) + " T";
      if (v >= 1e9)  return (v / 1e9).toFixed(2) + " B";
      if (v >= 1e6)  return (v / 1e6).toFixed(2) + " M";
      if (v >= 1e3)  return (v / 1e3).toFixed(2) + " K";
      return v.toFixed(0);
    }

    function setSourceBadge(kind, msg) {
      sourceDot.classList.remove("ok", "warn", "bad");
      if (kind === DataSource.BACKEND) sourceDot.classList.add("ok");
      else if (kind === DataSource.COINGECKO) sourceDot.classList.add("warn");
      else if (kind === DataSource.CACHE) sourceDot.classList.add("warn");
      else sourceDot.classList.add("bad");
      sourceText.textContent = msg;
    }

    function showErrorInTable(message) {
      coinsBody.innerHTML = "";
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 7;
      td.style.textAlign = "left";
      td.style.color = "#fca5a5";
      td.textContent = message;
      tr.appendChild(td);
      coinsBody.appendChild(tr);
    }

    function showLoadingRow(message = "Loading‚Ä¶") {
      coinsBody.innerHTML = "";
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 7;
      td.style.textAlign = "left";
      td.style.color = "#9ca3af";
      td.textContent = message;
      tr.appendChild(td);
      coinsBody.appendChild(tr);
    }

    // ==========================================================
    // CACHE (markets)
    // ==========================================================
    function loadMarketsCache() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_MARKETS);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || !Array.isArray(parsed.data) || typeof parsed.ts !== "number") return null;
        return parsed;
      } catch {
        return null;
      }
    }

    function saveMarketsCache(data) {
      try {
        localStorage.setItem(STORAGE_KEY_MARKETS, JSON.stringify({ ts: Date.now(), data }));
      } catch {}
    }

    function isCacheFresh(ts) {
      return (Date.now() - ts) <= MARKETS_CACHE_TTL_MS;
    }

    // ==========================================================
    // NET: robust fetch (timeout + retries)
    // ==========================================================
    async function fetchJsonWithRetry(url, {
      timeoutMs = 12000,
      retries = 1,
      retryDelayMs = 900,
      mode = "cors"
    } = {}) {
      let lastErr = null;

      for (let attempt = 0; attempt <= retries; attempt++) {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);

        try {
          const res = await fetch(url, {
            method: "GET",
            cache: "no-store",
            mode,
            signal: controller.signal,
            headers: { "Accept": "application/json" }
          });

          if (!res.ok) {
            const text = await res.text().catch(() => "");
            throw new Error(`HTTP ${res.status} ${res.statusText} ${text ? ("- " + text.slice(0, 220)) : ""}`);
          }

          return await res.json();
        } catch (err) {
          lastErr = err;
          if (attempt === retries) break;
          const wait = retryDelayMs * Math.pow(1.6, attempt);
          await new Promise(r => setTimeout(r, wait));
        } finally {
          clearTimeout(timer);
        }
      }
      throw lastErr;
    }

    // ==========================================================
    // DATA: build URLs
    // ==========================================================
    function buildMarketsUrlBase(base) {
      const normalized = base.endsWith("/") ? base.slice(0, -1) : base;
      return (
        normalized + BACKEND_MARKETS_ENDPOINT +
        `?vs_currency=usd` +
        `&order=market_cap_desc` +
        `&per_page=50` +
        `&page=1` +
        `&sparkline=false` +
        `&price_change_percentage=1h,24h,7d`
      );
    }

    function buildCoinGeckoMarketsUrl() {
      return (
        API_BASE + "/coins/markets" +
        `?vs_currency=usd` +
        `&order=market_cap_desc` +
        `&per_page=50` +
        `&page=1` +
        `&sparkline=false` +
        `&price_change_percentage=1h,24h,7d`
      );
    }

    function buildAiUrl({ coinId, days = 90, timeframe = "1d" }) {
      const base = BACKEND_BASE_URL.replace(/\/$/, "");
      const qs = new URLSearchParams({
        coin_id: coinId,
        days: String(days),
        timeframe: String(timeframe)
      });
      return `${base}${AI_ENDPOINT}?${qs.toString()}`;
    }

    // ==========================================================
    // MAIN: markets loader
    // ==========================================================
    async function loadMarkets({ reason = "auto" } = {}) {
      if (isLoadingMarkets) return;
      isLoadingMarkets = true;

      try {
        refreshBtn.disabled = true;
        refreshBtn.textContent = "Loading‚Ä¶";

        dailyInsightEl.textContent = "Loading market analysis...";
        showLoadingRow("Loading‚Ä¶");

        const cached = loadMarketsCache();
        const hasFreshCache = cached && isCacheFresh(cached.ts);

        if (hasFreshCache) {
          coinsRaw = cached.data.filter(Boolean);
          filteredCoins = [...coinsRaw];
          applySort();
          renderTable();
          makeDailyInsight();
          updateTimestamp();
          setSourceBadge(DataSource.CACHE, "Source: cache (last 60s) ‚úì");
          if (reason !== "manual") return;
        }

        const backendUrl = buildMarketsUrlBase(BACKEND_BASE_URL);
        try {
          const backendData = await fetchJsonWithRetry(backendUrl, { timeoutMs: 15000, retries: 1, retryDelayMs: 1000 });
          if (!Array.isArray(backendData)) throw new Error("Backend returned non-array JSON.");
          coinsRaw = backendData.filter(Boolean);
          saveMarketsCache(coinsRaw);
          setSourceBadge(DataSource.BACKEND, `Source: backend proxy ‚úì (${BACKEND_BASE_URL})`);
        } catch (errBackend) {
          console.warn("[Markets] backend failed, falling back to CoinGecko direct.", errBackend);
          setSourceBadge(DataSource.COINGECKO, "Source: CoinGecko direct (backend fallback) ‚ö†");
          const cgUrl = buildCoinGeckoMarketsUrl();
          const cgData = await fetchJsonWithRetry(cgUrl, { timeoutMs: 15000, retries: 1, retryDelayMs: 1200 });
          if (!Array.isArray(cgData)) throw new Error("CoinGecko returned non-array JSON.");
          coinsRaw = cgData.filter(Boolean);
          saveMarketsCache(coinsRaw);
        }

        filteredCoins = [...coinsRaw];
        applySort();
        renderTable();
        makeDailyInsight();
        updateTimestamp();

      } catch (err) {
        console.error("[Markets] load failed:", err);
        const cached = loadMarketsCache();
        if (cached && Array.isArray(cached.data) && cached.data.length) {
          coinsRaw = cached.data.filter(Boolean);
          filteredCoins = [...coinsRaw];
          applySort();
          renderTable();
          makeDailyInsight();
          updateTimestamp();
          setSourceBadge(DataSource.CACHE, "Source: cache (fallback after error) ‚ö†");
          dailyInsightEl.textContent = "Loaded from cache due to upstream error.";
        } else {
          setSourceBadge("error", "Source: FAILED (backend + CoinGecko + no cache)");
          showErrorInTable("Failed to load markets. Try again in 60s.");
          dailyInsightEl.textContent = "Error loading data (rate-limit / backend / network).";
        }
      } finally {
        isLoadingMarkets = false;
        refreshBtn.disabled = false;
        refreshBtn.textContent = "Refresh";
      }
    }

    // ==========================================================
    // SORT / FILTER / TABLE
    // ==========================================================
    function applySort() {
      const key = currentSort;
      filteredCoins.sort((a, b) => {
        if (key === "rank") return (a.market_cap_rank ?? 9999) - (b.market_cap_rank ?? 9999);
        if (key === "change24") return Math.abs(b.price_change_percentage_24h || 0) - Math.abs(a.price_change_percentage_24h || 0);
        if (key === "change1h") return Math.abs(b.price_change_percentage_1h_in_currency || 0) - Math.abs(a.price_change_percentage_1h_in_currency || 0);
        if (key === "change7d") return Math.abs(b.price_change_percentage_7d_in_currency || 0) - Math.abs(a.price_change_percentage_7d_in_currency || 0);
        return 0;
      });
    }

    function renderTable() {
      coinsBody.innerHTML = "";

      if (!filteredCoins.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.style.textAlign = "left";
        td.style.color = "#9ca3af";
        td.textContent = "No data yet. Try Refresh.";
        tr.appendChild(td);
        coinsBody.appendChild(tr);
        return;
      }

      filteredCoins.forEach((coin) => {
        const tr = document.createElement("tr");
        tr.dataset.id = coin.id;

        const rankTd = document.createElement("td");
        rankTd.innerHTML = `<span class="rank">${coin.market_cap_rank ?? "?"}</span>`;
        tr.appendChild(rankTd);

        const nameTd = document.createElement("td");
        nameTd.innerHTML = `
          <div class="coin-name">
            <span>${coin.name ?? "Unknown"}</span>
            <span class="coin-symbol">${(coin.symbol ?? "?").toUpperCase()}</span>
          </div>
        `;
        tr.appendChild(nameTd);

        const priceTd = document.createElement("td");
        priceTd.textContent = formatPrice(coin.current_price);
        tr.appendChild(priceTd);

        const chg1hTd = document.createElement("td");
        const chg1h = coin.price_change_percentage_1h_in_currency;
        chg1hTd.textContent = formatPercent(chg1h);
        chg1hTd.className = chg1h > 0 ? "chg-pos" : chg1h < 0 ? "chg-neg" : "";
        tr.appendChild(chg1hTd);

        const chg24Td = document.createElement("td");
        const chg24 = coin.price_change_percentage_24h;
        chg24Td.textContent = formatPercent(chg24);
        chg24Td.className = chg24 > 0 ? "chg-pos" : chg24 < 0 ? "chg-neg" : "";
        tr.appendChild(chg24Td);

        const chg7dTd = document.createElement("td");
        const chg7d = coin.price_change_percentage_7d_in_currency;
        chg7dTd.textContent = formatPercent(chg7d);
        chg7dTd.className = chg7d > 0 ? "chg-pos" : chg7d < 0 ? "chg-neg" : "";
        tr.appendChild(chg7dTd);

        const mcTd = document.createElement("td");
        mcTd.textContent = "$" + formatNumberAbbr(coin.market_cap ?? 0);
        tr.appendChild(mcTd);

        tr.addEventListener("click", () => handleCoinClick(coin.id));
        coinsBody.appendChild(tr);
      });
    }

    function filterCoins() {
      const q = (searchInput.value || "").toLowerCase().trim();
      if (!q) filteredCoins = [...coinsRaw];
      else {
        filteredCoins = coinsRaw.filter((c) =>
          (c.name || "").toLowerCase().includes(q) ||
          (c.symbol || "").toLowerCase().includes(q)
        );
      }
      applySort();
      renderTable();
    }

    function handleSortChange() {
      currentSort = sortSelect.value;
      applySort();
      renderTable();
    }

    // ==========================================================
    // DAILY INSIGHT (rules)
    // ==========================================================
    function makeDailyInsight() {
      if (!coinsRaw.length) {
        dailyInsightEl.textContent = "Not enough data yet. Try refresh.";
        return;
      }

      let sum24 = 0, count24 = 0;
      let topGainer = null, topLoser = null;
      let highVolMoves = 0;

      coinsRaw.forEach((c) => {
        const chg = c.price_change_percentage_24h;
        if (chg != null && !Number.isNaN(chg)) {
          sum24 += chg;
          count24++;
          if (!topGainer || chg > (topGainer.price_change_percentage_24h ?? -9999)) topGainer = c;
          if (!topLoser || chg < (topLoser.price_change_percentage_24h ?? 9999)) topLoser = c;
          if (Math.abs(chg) >= 5) highVolMoves++;
        }
      });

      const avg24 = count24 ? (sum24 / count24) : 0;
      let mood = "balanced / sideways";
      if (avg24 > 1.5) mood = "bullish";
      else if (avg24 < -1.5) mood = "bearish";

      const volatility =
        highVolMoves >= 10 ? "high (many moves > ¬±5% in 24h)"
        : highVolMoves >= 4 ? "medium (some strong spikes)"
        : "low (mostly moderate moves)";

      dailyInsightEl.innerHTML = `
        <p>
          Based on <strong>${count24}</strong> top coins by market cap, today‚Äôs overall market mood looks
          <strong>${mood}</strong>, with an average 24h change of <strong>${avg24.toFixed(2)}%</strong>.
        </p>
        <ul class="ai-list">
          <li><strong>Top gainer:</strong> <strong>${topGainer?.name ?? "N/A"}</strong> (${formatPercent(topGainer?.price_change_percentage_24h)} / 24h)</li>
          <li><strong>Top loser:</strong> <strong>${topLoser?.name ?? "N/A"}</strong> (${formatPercent(topLoser?.price_change_percentage_24h)} / 24h)</li>
          <li><strong>Volatility:</strong> <strong>${volatility}</strong></li>
          <li>Educational only, not financial advice.</li>
        </ul>
      `;
    }

    // ==========================================================
    // AI: fetch + scenarios format (Most / Alt / Rare)
    // ==========================================================
    async function fetchAiPredictionForCoin(coinId) {
      const url = buildAiUrl({ coinId, days: 90, timeframe: "1d" });
      return await fetchJsonWithRetry(url, { timeoutMs: 45000, retries: 0 });
    }

    function computeProbabilisticScenarios({ last, predicted, low, high }) {
      // small buffers for "spike" and "acceptance"
      const spikeBuffer = 0.003;   // 0.3%
      const acceptBuffer = 0.006;  // 0.6%

      // direction from AI
      const delta = (predicted - last) / Math.max(1e-9, last);
      const isBull = delta > 0.002;   // > +0.2%
      const isBear = delta < -0.002;  // < -0.2%

      // confidence from interval width
      const width = (high - low) / Math.max(1e-9, last);
      const tight = width < 0.04; // <4% interval ~ "tighter"
      const mostProb = tight ? 65 : 62;
      const altProb  = tight ? 25 : 28;
      const rareProb = Math.max(5, 100 - mostProb - altProb);

      if (isBear) {
        const reaction = last;
        const t1 = Math.max(low, predicted);
        const t2 = low;
        const t3 = low * (1 - 0.01);

        const spikeHi = high * (1 + spikeBuffer);
        const acceptHi = high * (1 + acceptBuffer);

        return {
          most: { prob: mostProb, title: "üìâ Scenariul CEL MAI PROBABIL", lines: [
            `‚û°Ô∏è Reac»õie bearish din ${formatPrice(reaction)}`,
            `${formatPrice(t1)} ‚Üí ${formatPrice(t2)} ‚Üí ${formatPrice(t3)}`
          ]},
          alt: { prob: altProb, title: "üîÑ Scenariul alternativ", lines: [
            `‚û°Ô∏è Spike scurt peste ${formatPrice(high)} ‚Äì ${formatPrice(spikeHi)}`
          ]},
          rare:{ prob: rareProb, title: "üü¢ Scenariul mai rar", lines: [
            `‚û°Ô∏è Acceptare peste ${formatPrice(acceptHi)}`
          ]}
        };
      }

      if (isBull) {
        const reaction = last;
        const t1 = Math.min(high, predicted);
        const t2 = high;
        const t3 = high * (1 + 0.01);

        const spikeLo = low * (1 - spikeBuffer);
        const acceptLo = low * (1 - acceptBuffer);

        return {
          most: { prob: mostProb, title: "üìà Scenariul CEL MAI PROBABIL", lines: [
            `‚û°Ô∏è Reac»õie bullish din ${formatPrice(reaction)}`,
            `${formatPrice(t1)} ‚Üí ${formatPrice(t2)} ‚Üí ${formatPrice(t3)}`
          ]},
          alt: { prob: altProb, title: "üîÑ Scenariul alternativ", lines: [
            `‚û°Ô∏è Spike scurt sub ${formatPrice(low)} ‚Äì ${formatPrice(spikeLo)}`
          ]},
          rare:{ prob: rareProb, title: "üü¢ Scenariul mai rar", lines: [
            `‚û°Ô∏è Acceptare sub ${formatPrice(acceptLo)}`
          ]}
        };
      }

      // neutral
      return {
        most: { prob: 62, title: "üìâ Scenariul CEL MAI PROBABIL", lines: [
          `‚û°Ô∏è Range / consolidare √Æn jurul ${formatPrice(last)}`,
          `${formatPrice(low)} ‚Üî ${formatPrice(high)}`
        ]},
        alt: { prob: 28, title: "üîÑ Scenariul alternativ", lines: [
          `‚û°Ô∏è Spike scurt cƒÉtre ${formatPrice(high * (1 + spikeBuffer))} sau ${formatPrice(low * (1 - spikeBuffer))}`
        ]},
        rare:{ prob: 10, title: "üü¢ Scenariul mai rar", lines: [
          `‚û°Ô∏è Acceptare √Æn afara intervalului (${formatPrice(high * (1 + acceptBuffer))} / ${formatPrice(low * (1 - acceptBuffer))})`
        ]}
      };
    }

    function renderProbabilisticScenarioList(scenarios) {
      scenarioListEl.innerHTML = "";

      const blocks = [scenarios.most, scenarios.alt, scenarios.rare];
      for (const b of blocks) {
        const li = document.createElement("li");
        li.innerHTML = `
          <div><strong>${b.title} (‚âà${b.prob}%)</strong></div>
          <div style="margin-top:2px;">
            ${b.lines.map(line => `<div>${line}</div>`).join("")}
          </div>
        `;
        scenarioListEl.appendChild(li);
      }
    }

    // ==========================================================
    // SELECT COIN + CHART + AI
    // ==========================================================
    async function handleCoinClick(id) {
      const coin = coinsRaw.find((c) => c.id === id);
      if (!coin) return;

      selectedNameEl.textContent = coin.name ?? "Unknown";
      selectedSymbolEl.textContent = (coin.symbol ?? "?").toUpperCase() + " / USD";
      selectedPriceEl.textContent = formatPrice(coin.current_price);
      metricMarketCapEl.textContent = "$" + formatNumberAbbr(coin.market_cap ?? 0);

      selectedPillsEl.innerHTML = "";

      const pill24 = document.createElement("span");
      pill24.className = "pill-info " + ((coin.price_change_percentage_24h ?? 0) > 0 ? "green" : (coin.price_change_percentage_24h ?? 0) < 0 ? "red" : "");
      pill24.textContent = "24h: " + formatPercent(coin.price_change_percentage_24h);
      selectedPillsEl.appendChild(pill24);

      const pill1h = document.createElement("span");
      pill1h.className = "pill-info " + ((coin.price_change_percentage_1h_in_currency ?? 0) > 0 ? "green" : (coin.price_change_percentage_1h_in_currency ?? 0) < 0 ? "red" : "");
      pill1h.textContent = "1h: " + formatPercent(coin.price_change_percentage_1h_in_currency);
      selectedPillsEl.appendChild(pill1h);

      const pill7d = document.createElement("span");
      pill7d.className = "pill-info " + ((coin.price_change_percentage_7d_in_currency ?? 0) > 0 ? "green" : (coin.price_change_percentage_7d_in_currency ?? 0) < 0 ? "red" : "");
      pill7d.textContent = "7d: " + formatPercent(coin.price_change_percentage_7d_in_currency);
      selectedPillsEl.appendChild(pill7d);

      // Chart (still CoinGecko direct)
      await loadChartForCoin(coin);

      // AI prediction + scenarios
      metricBiasEl.textContent = "Loading AI‚Ä¶";
      coinCommentEl.textContent = "Fetching AI prediction from backend‚Ä¶";
      scenarioListEl.innerHTML = "<li>Loading scenarios‚Ä¶</li>";

      try {
        const ai = await fetchAiPredictionForCoin(coin.id);

        const last = Number(ai.last_price);
        const predicted = Number(ai.predicted_price);
        const low = Number(ai.prediction_interval_68?.low);
        const high = Number(ai.prediction_interval_68?.high);
        const rsi = Number(ai.indicators?.rsi);

        const scenarios = computeProbabilisticScenarios({ last, predicted, low, high });
        renderProbabilisticScenarioList(scenarios);

        const model = ai.model || "ai";
        metricBiasEl.textContent = `${model} ‚Ä¢ RSI ${Number.isFinite(rsi) ? rsi.toFixed(2) : "‚Äî"}`;

        coinCommentEl.textContent =
          `Predic»õie: ${formatPrice(predicted)} (interval 68%: ${formatPrice(low)} ‚Äì ${formatPrice(high)}).`;

      } catch (e) {
        metricBiasEl.textContent = "AI unavailable";
        coinCommentEl.textContent = "AI endpoint failed. Try again later.";
        scenarioListEl.innerHTML = "<li>AI indisponibil momentan.</li>";
        console.error("[AI] failed:", e);
      }
    }

    async function loadChartForCoin(coin) {
      const id = coin.id;
      let chartData = chartCache.get(id);

      if (!chartData) {
        try {
          const url = `${API_BASE}/coins/${id}/market_chart?vs_currency=usd&days=7&interval=hourly`;
          const data = await fetchJsonWithRetry(url, { timeoutMs: 15000, retries: 1, retryDelayMs: 900, mode: "cors" });
          const prices = data.prices || [];

          const labels = [];
          const values = [];

          const step = Math.max(1, Math.floor(prices.length / 80));
          for (let i = 0; i < prices.length; i += step) {
            const [ts, p] = prices[i];
            const d = new Date(ts);
            labels.push(
              d.toLocaleDateString("en-GB", { day: "2-digit", month: "2-digit" }) + " " +
              d.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit" })
            );
            values.push(p);
          }

          chartData = { labels, values };
          chartCache.set(id, chartData);
        } catch (err) {
          console.error("[Chart] failed:", err);
          return;
        }
      }

      const ctx = document.getElementById("priceChart").getContext("2d");
      if (priceChart) priceChart.destroy();

      priceChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: chartData.labels,
          datasets: [{
            label: `${coin.name} ‚Äì price (USD)`,
            data: chartData.values,
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: "#e5e7eb", font: { size: 10 } } } },
          scales: {
            x: { ticks: { color: "#9ca3af", maxRotation: 0, autoSkip: true, autoSkipPadding: 16 }, grid: { display: false } },
            y: { ticks: { color: "#9ca3af", callback: (v) => "$" + Number(v).toFixed(0) }, grid: { color: "rgba(55, 65, 81, 0.6)" } }
          }
        }
      });
    }

    // ==========================================================
    // BACKEND TESTS
    // ==========================================================
    async function testHealth() {
      const url = `${BACKEND_BASE_URL.replace(/\/$/, "")}/health`;
      aiResult.textContent = "Calling: " + url;
      btnHealth.disabled = true;
      try {
        const data = await fetchJsonWithRetry(url, { timeoutMs: 12000, retries: 0, mode: "cors" });
        aiResult.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        aiResult.textContent = "Health error:\n" + String(err);
      } finally {
        btnHealth.disabled = false;
      }
    }

    async function handleAiBackendTest() {
      const coinId = (aiInput.value || "bitcoin").trim();
      if (!coinId) { aiResult.textContent = "Please enter a CoinGecko coin id."; return; }

      const url = buildAiUrl({ coinId, days: 90, timeframe: "1d" });
      aiResult.textContent = "Calling: " + url;
      btnTestBackend.disabled = true;

      try {
        const data = await fetchJsonWithRetry(url, { timeoutMs: 45000, retries: 0, mode: "cors" });

        document.getElementById("ai-summary-coin").textContent = data?.coin_id ?? "-";
        document.getElementById("ai-summary-last").textContent =
          (typeof data?.last_price === "number") ? data.last_price.toFixed(2) : "-";
        document.getElementById("ai-summary-predicted").textContent =
          (typeof data?.predicted_price === "number") ? data.predicted_price.toFixed(2) : "-";
        document.getElementById("ai-summary-rsi").textContent =
          (typeof data?.indicators?.rsi === "number") ? data.indicators.rsi.toFixed(2) : "-";

        aiResult.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        aiResult.textContent = "Error while calling backend:\n" + String(err);
      } finally {
        btnTestBackend.disabled = false;
      }
    }

    // ==========================================================
    // EVENTS + INIT
    // ==========================================================
    searchInput.addEventListener("input", filterCoins);
    sortSelect.addEventListener("change", handleSortChange);

    refreshBtn.addEventListener("click", async () => {
      const now = Date.now();
      const elapsed = now - lastManualRefreshTs;

      if (elapsed < REFRESH_MIN_INTERVAL_MS) {
        const remaining = Math.ceil((REFRESH_MIN_INTERVAL_MS - elapsed) / 1000);
        alert(`Te rog a»ôteaptƒÉ ${remaining}s √Ænainte de un nou refresh (protec»õie rate-limit).`);
        return;
      }

      lastManualRefreshTs = now;
      await loadMarkets({ reason: "manual" });
    });

    btnTestBackend.addEventListener("click", handleAiBackendTest);
    btnHealth.addEventListener("click", testHealth);

    document.addEventListener("DOMContentLoaded", () => {
      setSourceBadge("init", "Source: checking‚Ä¶");
      loadMarkets({ reason: "auto" });
    });
  </script>
</body>
</html>
