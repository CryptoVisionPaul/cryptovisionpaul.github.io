<!DOCTYPE html>
<html lang="en">
<head>
  <!-- (Optional) AdSense loader - keep if you already use it -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9902358545401183"
    crossorigin="anonymous"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CryptoVision – AI Crypto Insights</title>
  <meta name="description" content="CryptoVision – live crypto prices, pseudo-AI insights, and a ready-to-upgrade AI backend test panel." />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#050816;
      --bg2:#081026;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,.15);
      --danger:#f97373;
      --danger-soft:rgba(248,113,113,.15);
      --warning:#eab308;
      --text:#e5e7eb;
      --text-soft:#9ca3af;
      --border:#1f2937;
      --card:#0f172a;
      --card-soft:rgba(15,23,42,.9);
      --shadow:0 22px 60px rgba(0,0,0,.55);
      --font:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:var(--font);
      background:radial-gradient(circle at top,#111827,#020617);
      color:var(--text);
      display:flex;
      justify-content:center;
      padding:24px 12px;
    }
    .shell{
      width:100%;
      max-width:1280px;
      background:linear-gradient(135deg,#020617,#020617 40%,#020617 60%,#020617);
      border-radius:32px;
      box-shadow:var(--shadow);
      padding:24px 24px 28px;
      border:1px solid rgba(148,163,184,.25);
      position:relative;
      overflow:hidden;
    }
    .shell::before{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,.11), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(79,70,229,.11), transparent 55%),
        radial-gradient(circle at 50% 100%, rgba(34,197,94,.12), transparent 55%);
      opacity:.9; pointer-events:none; z-index:-1;
    }

    /* Top bar */
    .top-bar{
      display:flex; justify-content:space-between; gap:16px;
      align-items:center; margin-bottom:18px; flex-wrap:wrap;
    }
    .logo-wrap{display:flex; align-items:center; gap:14px}
    .logo-badge{
      width:40px;height:40px;border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#4ade80,#22c55e);
      display:flex;align-items:center;justify-content:center;
      color:#020617;font-weight:800;font-size:18px;
      box-shadow:0 0 0 1px rgba(15,23,42,.5),0 18px 38px rgba(22,163,74,.55);
    }
    .title-block h1{
      font-size:22px; letter-spacing:.03em;
      display:flex; align-items:center; gap:8px;
    }
    .title-pill{
      font-size:11px; padding:2px 8px; border-radius:999px;
      border:1px solid rgba(96,165,250,.7);
      color:#bfdbfe;
      background:linear-gradient(135deg,rgba(37,99,235,.45),rgba(56,189,248,.1));
      text-transform:uppercase;
    }
    .title-block p{font-size:13px;color:var(--text-soft);margin-top:3px}

    .status-wrap{display:flex; flex-direction:column; align-items:flex-end; gap:6px; font-size:12px}
    .live-badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      background:rgba(22,163,74,.12); color:#bbf7d0;
      border:1px solid rgba(34,197,94,.6);
      font-size:11px; text-transform:uppercase; letter-spacing:.08em;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.3)}
    .updated-at{font-size:12px;color:var(--text-soft)}

    /* Feature section */
    .grid-top{
      display:grid; grid-template-columns:minmax(0,3fr) minmax(0,2fr);
      gap:18px; margin-bottom:16px;
    }
    .pill-row{display:flex; flex-wrap:wrap; gap:10px}
    .feature-pill{
      display:flex; align-items:center; gap:6px;
      padding:7px 10px; border-radius:999px; font-size:11px;
      background:rgba(15,23,42,.8);
      border:1px solid rgba(148,163,184,.35);
      backdrop-filter:blur(16px);
    }
    .feature-pill span.icon{
      width:16px;height:16px;border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:11px;
    }
    .feature-pill.good span.icon{background:rgba(34,197,94,.18);color:#bbf7d0}
    .feature-pill.info span.icon{background:rgba(59,130,246,.18);color:#bfdbfe}
    .feature-pill.ad span.icon{background:rgba(234,179,8,.18);color:#fef9c3}
    .mini-note{font-size:11px;color:#9ca3af;margin-top:6px}

    .top-info-card{
      padding:10px 14px; border-radius:18px;
      background:rgba(15,23,42,.88);
      border:1px solid rgba(148,163,184,.35);
      backdrop-filter:blur(16px); font-size:12px;
    }
    .top-info-card strong{color:#e5e7eb}

    /* Layout */
    .main-grid{
      display:grid;
      grid-template-columns:minmax(0,3.3fr) minmax(0,2.7fr);
      gap:18px;
    }
    .card{
      background:var(--card-soft);
      border-radius:22px;
      padding:14px 14px 16px;
      border:1px solid rgba(148,163,184,.3);
      box-shadow:0 18px 45px rgba(15,23,42,.9);
      backdrop-filter:blur(18px);
      position:relative; overflow:hidden;
    }
    .card::before{
      content:""; position:absolute; inset:-40%;
      background:radial-gradient(circle at 0 0, rgba(59,130,246,.22), transparent 55%);
      opacity:0; transition:opacity .35s ease-out; pointer-events:none; z-index:-1;
    }
    .card:hover::before{opacity:.25}

    .card-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px}
    .card-title{font-size:14px;font-weight:600}
    .card-subtitle{font-size:11px;color:var(--text-soft)}
    .badge{
      padding:3px 8px; border-radius:999px;
      font-size:10px; letter-spacing:.06em; text-transform:uppercase;
      border:1px solid rgba(148,163,184,.5); color:#e5e7eb;
    }
    .badge.green{border-color:rgba(34,197,94,.7);background:rgba(22,163,74,.12);color:#bbf7d0}
    .badge.blue{border-color:rgba(59,130,246,.7);background:rgba(37,99,235,.18);color:#bfdbfe}
    .badge.orange{border-color:rgba(234,179,8,.7);background:rgba(234,179,8,.16);color:#fef3c7}

    /* Toolbar */
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;align-items:center;font-size:12px}
    .search-box{flex:1}
    .search-input{
      width:100%; padding:7px 9px; border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(15,23,42,.9); color:var(--text);
      font-size:12px; outline:none;
    }
    .search-input::placeholder{color:#6b7280}
    .select-small,.btn-small{
      border-radius:999px; border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.9); color:var(--text-soft);
      font-size:11px; padding:6px 9px; outline:none; cursor:pointer;
    }
    .btn-small.primary{
      background:linear-gradient(to right,#2563eb,#22c55e);
      border-color:transparent; color:#ecfeff; font-weight:500;
    }
    .btn-small.primary:hover{filter:brightness(1.05)}

    /* Table */
    .table-wrap{
      max-height:420px; overflow:auto; border-radius:16px;
      border:1px solid rgba(31,41,55,.9);
      background:radial-gradient(circle at top, rgba(15,23,42,.96), #020617);
    }
    table{width:100%; border-collapse:collapse; font-size:12px}
    thead{
      background:rgba(15,23,42,.95);
      position:sticky; top:0; z-index:2;
    }
    th,td{
      padding:7px 10px; text-align:right;
      border-bottom:1px solid rgba(31,41,55,.9);
      white-space:nowrap;
    }
    th:first-child,td:first-child{text-align:left}
    th:nth-child(2),td:nth-child(2){text-align:left}
    th{
      font-size:11px; color:#9ca3af;
      text-transform:uppercase; letter-spacing:.06em;
    }
    tbody tr{cursor:pointer; transition:background .15s ease-out}
    tbody tr:nth-child(even){background:rgba(15,23,42,.85)}
    tbody tr:hover{background:rgba(37,99,235,.18)}
    .rank{color:#6b7280;font-size:11px}
    .coin-name{display:flex; align-items:center; gap:6px}
    .coin-symbol{
      font-size:10px; text-transform:uppercase; color:#9ca3af;
      padding:1px 5px; border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
    }
    .chg-pos{color:#22c55e}
    .chg-neg{color:#f97373}

    /* Right panel */
    .ai-text{font-size:12px; line-height:1.55; color:#e5e7eb}
    .ai-text strong{color:#bfdbfe}
    .ai-list{margin-top:8px; list-style:none; font-size:12px; color:#cbd5f5}
    .ai-list li{margin-bottom:4px; position:relative; padding-left:14px}
    .ai-list li::before{content:"•"; position:absolute; left:2px; color:#60a5fa}

    .small-label{font-size:11px; color:#9ca3af; margin-bottom:4px}
    .pair-header{display:flex; justify-content:space-between; align-items:baseline; margin-bottom:4px; gap:4px; flex-wrap:wrap}
    .pair-name{font-size:14px; font-weight:600}
    .pair-symbol{font-size:11px; text-transform:uppercase; color:#9ca3af}
    .big-price{font-size:20px; font-weight:600}

    .pill-row-small{display:flex; flex-wrap:wrap; gap:6px; margin:6px 0 10px; font-size:11px}
    .pill-info{
      padding:3px 7px; border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      color:#e5e7eb; background:rgba(15,23,42,.9);
    }
    .pill-info.green{border-color:rgba(34,197,94,.7); background:var(--accent-soft); color:#bbf7d0}
    .pill-info.red{border-color:rgba(248,113,113,.75); background:var(--danger-soft); color:#fecaca}

    .metric-grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; font-size:11px; margin-bottom:10px}
    .metric-item{
      padding:6px 8px; border-radius:12px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(30,64,175,.8);
    }
    .metric-label{color:#9ca3af; margin-bottom:2px}
    .metric-value{font-weight:600}
    .metric-note{font-size:10px; color:#9ca3af; margin-top:2px}

    .ai-comment{
      margin-top:2px;
      padding:7px 9px;
      border-radius:12px;
      background:rgba(15,23,42,.9);
      border:1px dashed rgba(148,163,184,.7);
      font-size:12px; line-height:1.5;
      color:#e5e7eb;
    }

    .scenario-block{margin-top:8px; font-size:11px}
    .scenario-block strong{color:#bfdbfe}
    .scenario-list{list-style:none; margin-top:4px}
    .scenario-list li{margin-bottom:2px}

    .chart-wrap{
      margin-top:10px;
      background:radial-gradient(circle at top, rgba(30,64,175,.4), #020617);
      border-radius:14px;
      padding:8px 8px 4px;
      border:1px solid rgba(30,64,175,.8);
    }
    .chart-wrap canvas{width:100%; height:210px; max-height:210px}

    .ad-card{
      margin-top:12px;
      padding:10px 12px;
      border-radius:16px;
      border:1px dashed rgba(234,179,8,.7);
      background:rgba(24,16,3,.8);
      font-size:11px; color:#fef9c3;
    }
    .ad-card strong{color:#facc15}

    .footer-note{margin-top:10px; font-size:10px; color:#6b7280; text-align:right}

    /* Backend panel */
    .backend-grid{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,1fr);
      gap:12px;
      margin-top:16px;
    }
    .panel{
      border-radius:18px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(15,23,42,.75);
      padding:14px;
    }
    .panel h2,.panel h3{font-size:14px; margin-bottom:8px}
    .panel p{font-size:12px; color:var(--text-soft); line-height:1.5}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:10px 0}
    .input{
      padding:7px 10px; border-radius:10px;
      border:1px solid rgba(148,163,184,.35);
      background:#020617; color:#f9fafb;
      min-width:180px; outline:none;
    }
    .btn{
      padding:7px 14px; border-radius:999px;
      border:none; background:#22c55e; color:#020617;
      font-weight:700; cursor:pointer;
    }
    .btn:hover{filter:brightness(1.05)}
    pre{
      max-height:260px; overflow:auto;
      background:#020617; border-radius:12px;
      padding:10px; font-size:12px;
      border:1px solid #1f2937; color:#e5e7eb;
      white-space:pre-wrap;
    }

    @media (max-width: 900px){
      body{padding:12px 6px}
      .shell{border-radius:20px; padding:14px}
      .grid-top,.main-grid,.backend-grid{grid-template-columns:minmax(0,1fr)}
      .status-wrap{align-items:flex-start}
      .table-wrap{max-height:360px}
    }
  </style>
</head>

<body>
  <div class="shell">

    <!-- HEADER -->
    <header class="top-bar">
      <div class="logo-wrap">
        <div class="logo-badge">CV</div>
        <div class="title-block">
          <h1>CryptoVision <span class="title-pill">AI Crypto Insights</span></h1>
          <p>Live crypto prices + pseudo-AI insights. (Ready for real AI backend upgrade)</p>
        </div>
      </div>
      <div class="status-wrap">
        <div class="live-badge"><span class="dot"></span><span>Live market feed (real-time-ish)</span></div>
        <div class="updated-at" id="updatedAtText">Updated: —</div>
      </div>
    </header>

    <!-- FEATURES -->
    <section class="grid-top">
      <div>
        <div class="pill-row">
          <div class="feature-pill good"><span class="icon">✓</span><span class="label">Live prices (CoinGecko)</span></div>
          <div class="feature-pill good"><span class="icon">✓</span><span class="label">Pseudo-AI multi-timeframe style</span></div>
          <div class="feature-pill info"><span class="icon">AI</span><span class="label">Per-coin quick analysis</span></div>
          <div class="feature-pill info"><span class="icon">UX</span><span class="label">Modern blue + dark UI</span></div>
          <div class="feature-pill ad"><span class="icon">Ad</span><span class="label">AdSense / affiliate area</span></div>
          <div class="feature-pill info"><span class="icon">∞</span><span class="label">Prepared for real AI backend</span></div>
        </div>
        <p class="mini-note">
          This page runs in the browser (GitHub Pages). Coin list and chart use public CoinGecko endpoints.
          A real AI backend can be added via the test panel below.
        </p>
      </div>

      <div class="top-info-card">
        <div class="card-header" style="margin-bottom:6px;">
          <div>
            <div class="card-title">CryptoVision “Auto-Analysis” module</div>
            <div class="card-subtitle">Live data + rule-based logic for a quick market pulse.</div>
          </div>
          <span class="badge blue">Beta</span>
        </div>
        <p style="margin-bottom:4px;">
          <strong>How it works:</strong> CryptoVision loads the top 50 coins by market cap,
          computes average 24h change, top gainer/loser, volatility level, and generates a summary.
        </p>
        <p class="mini-note">
          This is pseudo-AI (rules). Later we can switch to real AI (LSTM / Transformer) via an API
          without changing the UI.
        </p>
      </div>
    </section>

    <!-- MAIN GRID -->
    <section class="main-grid">

      <!-- LEFT: TABLE -->
      <article class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Watched coins</div>
            <div class="card-subtitle">Top 50 by market cap – data from CoinGecko.</div>
          </div>
          <span class="badge">USD</span>
        </div>

        <div class="toolbar">
          <div class="search-box">
            <input id="searchInput" class="search-input" type="text" placeholder="Search coin (e.g. bitcoin, eth, bnb)..." />
          </div>
          <select id="sortSelect" class="select-small">
            <option value="rank">Sort: Market Cap</option>
            <option value="change24">Sort: Biggest 24h moves</option>
            <option value="change1h">Sort: Biggest 1h moves</option>
            <option value="change7d">Sort: Biggest 7d moves</option>
          </select>
          <button id="refreshBtn" class="btn-small primary">Refresh</button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Coin</th>
                <th>Price</th>
                <th>1h</th>
                <th>24h</th>
                <th>7d</th>
                <th>Market Cap</th>
              </tr>
            </thead>
            <tbody id="coinsBody"></tbody>
          </table>
        </div>
      </article>

      <!-- RIGHT: INSIGHT + SELECTED -->
      <article>
        <div class="card" style="margin-bottom:12px;">
          <div class="card-header">
            <div>
              <div class="card-title">CryptoVision AI – Daily Insight</div>
              <div class="card-subtitle">Automatic summary based on the top 50 coins.</div>
            </div>
            <span class="badge green">Pseudo-AI engine</span>
          </div>
          <div class="ai-text" id="dailyInsight">Loading market analysis...</div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Selected coin analysis</div>
              <div class="card-subtitle">Click a coin in the list to get details + chart.</div>
            </div>
            <span class="badge orange">Focus asset</span>
          </div>

          <div class="small-label">Selected</div>
          <div class="pair-header">
            <div>
              <div class="pair-name" id="selectedName">No coin selected</div>
              <div class="pair-symbol" id="selectedSymbol">Choose from the list</div>
            </div>
            <div class="big-price" id="selectedPrice">—</div>
          </div>

          <div class="pill-row-small" id="selectedPills">
            <span class="pill-info">Waiting for a selection...</span>
          </div>

          <div class="metric-grid">
            <div class="metric-item">
              <div class="metric-label">Market Cap</div>
              <div class="metric-value" id="metricMarketCap">—</div>
              <div class="metric-note">Project size vs market.</div>
            </div>
            <div class="metric-item">
              <div class="metric-label">Directional bias</div>
              <div class="metric-value" id="metricBias">—</div>
              <div class="metric-note">Rule-based (24h + 7d).</div>
            </div>
          </div>

          <div class="ai-comment" id="coinComment">
            Select a coin to generate a pseudo-AI comment and simple support/resistance scenarios.
          </div>

          <div class="scenario-block">
            <strong>Auto scenarios:</strong>
            <ul class="scenario-list" id="scenarioList"><li>—</li></ul>
          </div>

          <div class="chart-wrap">
            <div class="small-label" style="margin-bottom:4px;">Chart – last 7 days (USD)</div>
            <canvas id="priceChart"></canvas>
          </div>

          <div class="ad-card">
            <strong>ADS / AFFILIATE AREA</strong><br/>
            Place your AdSense units or affiliate banners here after approval.
          </div>

          <div class="footer-note">
            Educational / informational only. Not financial advice.
          </div>
        </div>
      </article>
    </section>

    <!-- BACKEND TEST + SUMMARY -->
    <section class="backend-grid">
      <div class="panel">
        <h2>AI Backend Test</h2>
        <p>
          Calls your FastAPI endpoint: <code>/demo/prediction</code> (example: bitcoin, ethereum).
          If you haven’t deployed backend yet, keep it empty and it will show a friendly message.
        </p>

        <div class="row">
          <label for="ai-coin-id-input" style="font-size:12px; color:var(--text-soft);">Coin ID:</label>
          <input id="ai-coin-id-input" class="input" type="text" value="bitcoin" />
          <button class="btn" type="button" id="btnTestBackend">Test AI Backend</button>
        </div>

        <pre id="ai-backend-result">No request yet.</pre>
      </div>

      <div class="panel">
        <h3>AI Summary (Demo)</h3>
        <p>This box updates after you call the backend.</p>
        <div style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:10px; font-size:12px;">
          <div>
            <div style="opacity:.75;">Coin</div>
            <strong id="ai-summary-coin">-</strong>
          </div>
          <div>
            <div style="opacity:.75;">Last price</div>
            <strong id="ai-summary-last">-</strong>
          </div>
          <div>
            <div style="opacity:.75;">Predicted price</div>
            <strong id="ai-summary-predicted">-</strong>
          </div>
          <div>
            <div style="opacity:.75;">RSI</div>
            <strong id="ai-summary-rsi">-</strong>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- ✅ ONE CLEAN SCRIPT BLOCK (ALL JS) -->
  <script>
    // ------------------------------
    // CONFIG
    // ------------------------------
    const API_BASE = "https://api.coingecko.com/api/v3";

    // Put your public backend URL here (Render/Railway/Fly/etc).
    // Example: "https://cryptovision-backend.onrender.com"
    const BACKEND_BASE_URL = "https://cryptovision-ldo7.onrender.com";
// --- BACKEND CONNECTIVITY TEST ---
async function testBackend() {
  try {
    const res = await fetch(`${BACKEND_BASE_URL}/health`);
    const data = await res.json();
    console.log("✅ Backend health:", data);
  } catch (err) {
    console.error("❌ Backend NOT reachable", err);
  }
}
testBackend();



    // ------------------------------
    // STATE
    // ------------------------------
    let coinsRaw = [];
    let filteredCoins = [];
    let currentSort = "rank";
    let priceChart = null;
    const chartCache = new Map();

    // DOM refs
    const coinsBody = document.getElementById("coinsBody");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");
    const refreshBtn = document.getElementById("refreshBtn");
    const updatedAtText = document.getElementById("updatedAtText");
    const dailyInsightEl = document.getElementById("dailyInsight");

    const selectedNameEl = document.getElementById("selectedName");
    const selectedSymbolEl = document.getElementById("selectedSymbol");
    const selectedPriceEl = document.getElementById("selectedPrice");
    const selectedPillsEl = document.getElementById("selectedPills");
    const metricMarketCapEl = document.getElementById("metricMarketCap");
    const metricBiasEl = document.getElementById("metricBias");
    const coinCommentEl = document.getElementById("coinComment");
    const scenarioListEl = document.getElementById("scenarioList");

    const aiInput = document.getElementById("ai-coin-id-input");
    const aiResult = document.getElementById("ai-backend-result");
    const btnTestBackend = document.getElementById("btnTestBackend");

    // ------------------------------
    // HELPERS
    // ------------------------------
    function updateTimestamp() {
      const now = new Date();
      const formatted = now.toLocaleString("en-GB", {
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
      updatedAtText.textContent = "Updated: " + formatted;
    }

    function formatPrice(value) {
      if (value == null || Number.isNaN(value)) return "—";
      const v = Number(value);
      if (v >= 1000) return "$" + v.toLocaleString("en-US", { maximumFractionDigits: 0 });
      if (v >= 1) return "$" + v.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      if (v >= 0.01) return "$" + v.toLocaleString("en-US", { minimumFractionDigits: 4, maximumFractionDigits: 4 });
      return "$" + v.toLocaleString("en-US", { minimumFractionDigits: 6, maximumFractionDigits: 8 });
    }

    function formatPercent(value) {
      if (value == null || Number.isNaN(value)) return "—";
      const v = Number(value);
      const sign = v > 0 ? "+" : "";
      return sign + v.toFixed(2) + "%";
    }

    function formatNumberAbbr(value) {
      if (value == null || Number.isNaN(value)) return "—";
      const v = Number(value);
      if (v >= 1e12) return (v / 1e12).toFixed(2) + " T";
      if (v >= 1e9) return (v / 1e9).toFixed(2) + " B";
      if (v >= 1e6) return (v / 1e6).toFixed(2) + " M";
      if (v >= 1e3) return (v / 1e3).toFixed(2) + " K";
      return v.toFixed(0);
    }

    // ------------------------------
    // COINGECKO: FETCH TOP COINS
    // ------------------------------
   async function fetchCoins() {
  // Poate veni fie din CoinGecko direct, fie din backend (object cu .coins)
  const url = `${BACKEND_BASE_URL}/coins/simple`;

  try {
    dailyInsightEl.textContent = "Loading market analysis...";
    const res = await fetch(url, { cache: "no-store" });

    if (!res.ok) throw new Error("Failed to load data. HTTP " + res.status);

    const data = await res.json();

    // Acceptăm ambele formate:
    // 1) array direct: [ ... ]
    // 2) object: { coins: [ ... ] }
    const rawArray = Array.isArray(data) ? data : (Array.isArray(data.coins) ? data.coins : []);

    // Normalizăm ca UI-ul să nu se strice dacă backend-ul trimite doar {id, price, trend}
    coinsRaw = rawArray.map((c, idx) => {
      // Dacă are deja format CoinGecko markets, îl lăsăm
      if (c && typeof c === "object" && ("current_price" in c || "market_cap_rank" in c)) {
        return c;
      }

      // Format simplu din backend: { id, price, trend }
      const id = c?.id ?? `coin-${idx}`;
      const price = (typeof c?.price === "number") ? c.price : null;

      // fallback pt name/symbol
      const name = (id || "Unknown").replace(/(^|-)\w/g, m => m.toUpperCase()).replace(/-/g, " ");
      const symbol = (id || "UNK").split("-")[0].slice(0, 6).toUpperCase();

      return {
        id,
        name,
        symbol,
        current_price: price,
        market_cap_rank: null,
        market_cap: 0,
        price_change_percentage_1h_in_currency: null,
        price_change_percentage_24h: null,
        price_change_percentage_7d_in_currency: null,
        __trend: c?.trend ?? null, // dacă vrei să-l folosești mai târziu
      };
    });

    filteredCoins = [...coinsRaw];

    applySort();
    renderTable();
    makeDailyInsight();
    updateTimestamp();
  } catch (err) {
    console.error(err);
    dailyInsightEl.textContent =
      "Error loading data. Please refresh and check backend endpoint.";
  }
}


    function filterCoins() {
      const q = (searchInput.value || "").toLowerCase().trim();
      if (!q) filteredCoins = [...coinsRaw];
      else {
        filteredCoins = coinsRaw.filter((c) =>
          (c.name || "").toLowerCase().includes(q) ||
          (c.symbol || "").toLowerCase().includes(q)
        );
      }
      applySort();
      renderTable();
    }

    function handleSortChange() {
      currentSort = sortSelect.value;
      applySort();
      renderTable();
    }

    // ------------------------------
    // SELECT COIN + CHART
    // ------------------------------
    async function handleCoinClick(id) {
      const coin = coinsRaw.find((c) => c.id === id);
      if (!coin) return;

      selectedNameEl.textContent = coin.name ?? "Unknown";
      selectedSymbolEl.textContent = (coin.symbol ?? "?").toUpperCase() + " / USD";
      selectedPriceEl.textContent = formatPrice(coin.current_price);
      metricMarketCapEl.textContent = "$" + formatNumberAbbr(coin.market_cap ?? 0);

      selectedPillsEl.innerHTML = "";

      const pill24 = document.createElement("span");
      pill24.className = "pill-info " + ((coin.price_change_percentage_24h ?? 0) > 0 ? "green" : (coin.price_change_percentage_24h ?? 0) < 0 ? "red" : "");
      pill24.textContent = "24h: " + formatPercent(coin.price_change_percentage_24h);
      selectedPillsEl.appendChild(pill24);

      const pill1h = document.createElement("span");
      pill1h.className = "pill-info " + ((coin.price_change_percentage_1h_in_currency ?? 0) > 0 ? "green" : (coin.price_change_percentage_1h_in_currency ?? 0) < 0 ? "red" : "");
      pill1h.textContent = "1h: " + formatPercent(coin.price_change_percentage_1h_in_currency);
      selectedPillsEl.appendChild(pill1h);

      const pill7d = document.createElement("span");
      pill7d.className = "pill-info " + ((coin.price_change_percentage_7d_in_currency ?? 0) > 0 ? "green" : (coin.price_change_percentage_7d_in_currency ?? 0) < 0 ? "red" : "");
      pill7d.textContent = "7d: " + formatPercent(coin.price_change_percentage_7d_in_currency);
      selectedPillsEl.appendChild(pill7d);

      const biasInfo = computeBias(coin);
      metricBiasEl.textContent = biasInfo.label;
      coinCommentEl.textContent = biasInfo.comment;
      renderScenarios(biasInfo);

      await loadChartForCoin(coin);
    }

    function computeBias(coin) {
      const ch24 = coin.price_change_percentage_24h ?? 0;
      const ch7 = coin.price_change_percentage_7d_in_currency ?? 0;
      const price = coin.current_price ?? 0;

      const support = price * 0.97;
      const resistance = price * 1.03;

      let bias = "Neutral";
      let prob = 50;
      let comment = "";

      if (ch24 > 4 && ch7 > 10) {
        bias = "Strong bullish";
        prob = 70;
        comment = `${coin.name} shows strong momentum (24h and 7d aligned). Watch support near ${formatPrice(support)}.`;
      } else if (ch24 > 1 && ch7 >= 0) {
        bias = "Moderate bullish";
        prob = 60;
        comment = `${coin.name} is trending positive. Support near ${formatPrice(support)}; resistance near ${formatPrice(resistance)}.`;
      } else if (ch24 < -4 && ch7 < -8) {
        bias = "Strong bearish";
        prob = 72;
        comment = `${coin.name} is under strong selling pressure. Below support (${formatPrice(support)}) risk increases.`;
      } else if (ch24 < -1 && ch7 <= 0) {
        bias = "Moderate bearish";
        prob = 60;
        comment = `${coin.name} shows short-term weakness. If it fails to reclaim ${formatPrice(resistance)}, downside remains open.`;
      } else {
        bias = "Neutral / consolidation";
        prob = 50;
        comment = `${coin.name} is in a balance zone. Watch reactions near support (${formatPrice(support)}) and resistance (${formatPrice(resistance)}).`;
      }

      return { label: `${bias} (${prob}% tilt)`, comment, support, resistance };
    }

    function renderScenarios(biasInfo) {
      const sup = biasInfo.support;
      const res = biasInfo.resistance;

      const longTrigger = res * 1.005;
      const shortTrigger = sup * 0.995;

      scenarioListEl.innerHTML = "";
      const li1 = document.createElement("li");
      li1.textContent = `Long only above ${formatPrice(longTrigger)} (breakout confirmation).`;
      const li2 = document.createElement("li");
      li2.textContent = `Short only below ${formatPrice(shortTrigger)} (clear support breakdown).`;
      const li3 = document.createElement("li");
      li3.textContent = `No-trade zone roughly between ${formatPrice(sup)} and ${formatPrice(res)} (consolidation).`;

      scenarioListEl.appendChild(li1);
      scenarioListEl.appendChild(li2);
      scenarioListEl.appendChild(li3);
    }

    async function loadChartForCoin(coin) {
      const id = coin.id;
      let chartData = chartCache.get(id);

      if (!chartData) {
        try {
          const url = `${API_BASE}/coins/${id}/market_chart?vs_currency=usd&days=7&interval=hourly`;
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error("Chart history error. HTTP " + res.status);
          const data = await res.json();
          const prices = data.prices || [];

          const labels = [];
          const values = [];

          const step = Math.max(1, Math.floor(prices.length / 80));
          for (let i = 0; i < prices.length; i += step) {
            const [ts, p] = prices[i];
            const d = new Date(ts);
            labels.push(
              d.toLocaleDateString("en-GB", { day: "2-digit", month: "2-digit" }) + " " +
              d.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit" })
            );
            values.push(p);
          }

          chartData = { labels, values };
          chartCache.set(id, chartData);
        } catch (err) {
          console.error(err);
          return;
        }
      }

      const ctx = document.getElementById("priceChart").getContext("2d");
      if (priceChart) priceChart.destroy();

      priceChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: chartData.labels,
          datasets: [{
            label: `${coin.name} – price (USD)`,
            data: chartData.values,
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: "#e5e7eb", font: { size: 10 } } }
          },
          scales: {
            x: { ticks: { color: "#9ca3af", maxRotation: 0, autoSkip: true, autoSkipPadding: 16 }, grid: { display: false } },
            y: { ticks: { color: "#9ca3af", callback: (v) => "$" + Number(v).toFixed(0) }, grid: { color: "rgba(55, 65, 81, 0.6)" } }
          }
        }
      });
    }

    // ------------------------------
    // BACKEND TEST (SAFE)
    // ------------------------------
    async function handleAiBackendTest() {
      const coinId = (aiInput.value || "bitcoin").trim();
      if (!coinId) {
        aiResult.textContent = "Please enter a CoinGecko coin id.";
        return;
      }

      if (!BACKEND_BASE_URL || BACKEND_BASE_URL.includes("YOUR-BACKEND-URL-HERE")) {
        aiResult.textContent =
          "Backend URL is not set yet.\n\n" +
          "Edit app.html and set:\n" +
          'const BACKEND_BASE_URL = "https://your-backend-domain";\n\n' +
          "Then try again.";
        return;
      }

      const url = `${BACKEND_BASE_URL}/demo/prediction?coin_id=${encodeURIComponent(coinId)}&days=90`;
      aiResult.textContent = "Loading from backend...\n" + url;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("HTTP " + response.status);

        const data = await response.json();

        // Update summary safely
        document.getElementById("ai-summary-coin").textContent = data?.coin_id ?? "-";
        document.getElementById("ai-summary-last").textContent =
          (typeof data?.last_price === "number") ? data.last_price.toFixed(2) : "-";
        document.getElementById("ai-summary-predicted").textContent =
          (typeof data?.predicted_price === "number") ? data.predicted_price.toFixed(2) : "-";
        document.getElementById("ai-summary-rsi").textContent =
          (typeof data?.indicators?.rsi === "number") ? data.indicators.rsi.toFixed(2) : "-";

        aiResult.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        aiResult.textContent =
          "Error while calling backend:\n" + String(err) +
          "\n\nNotes:\n- BACKEND_BASE_URL must be a PUBLIC URL\n- Backend must allow CORS for https://cryptovisionpaul.github.io\n";
      }
    }

    // ------------------------------
    // EVENTS + INIT
    // ------------------------------
    searchInput.addEventListener("input", filterCoins);
    sortSelect.addEventListener("change", handleSortChange);
    refreshBtn.addEventListener("click", fetchCoins);
    btnTestBackend.addEventListener("click", handleAiBackendTest);

    document.addEventListener("DOMContentLoaded", () => {
      fetchCoins();
    });
  </script>
</body>
</html>
